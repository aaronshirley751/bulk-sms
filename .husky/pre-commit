#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Running PMD analysis on staged Apex files..."

# Get staged Apex files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.cls$")

if [ -n "$STAGED_FILES" ]; then
    # Run PMD on staged files
    pmd check --dir "$STAGED_FILES" \
        --rulesets config/pmd-ruleset.xml \
        --format text \
        --fail-on-violation false
    
    PMD_EXIT=$?
    
    if [ $PMD_EXIT -ne 0 ]; then
        echo "⚠️  PMD found issues. Review above and fix critical violations."
        echo "Run 'npm run pmd:fix' to see detailed report"
        read -p "Continue with commit anyway? (y/n) " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi
fi

npm run prettier:verify